<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LOSWords â€“ Gallery</title>
<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #6b7280;
  color: #e5e7eb;
  margin: 0;
  padding: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Centered content shell with responsive width */
.shell {
  width: 100%;
  max-width: 420px;
  margin: 0 auto;
}
@media (min-width: 768px) {
  .shell {
    max-width: 960px;
  }
}

#top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 6px 0 6px;
}
h1 {
  margin: 0;
  font-size: 24px;
}
#backButton {
  background: #4b5563;
  border: 1px solid #374151;
  border-radius: 999px;
  padding: 6px 12px;
  color: #f9fafb;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}
#intro {
  font-size: 14px;
  text-align: center;
  margin-bottom: 8px;
}

/* View controls */
#viewControls {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  margin-bottom: 10px;
}
.view-toggle {
  background: #4b5563;
  border: 1px solid #374151;
  border-radius: 999px;
  padding: 4px 10px;
  color: #e5e7eb;
  font-size: 12px;
  cursor: pointer;
}
.view-toggle-active {
  background: #facc15;
  border-color: #fbbf24;
  color: #111827;
}

/* Gallery view modes */
#gallery {
  margin-bottom: 20px;
}
#gallery.list-view {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
#gallery.tiles-view {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
  gap: 14px;
}

/* Cards */
.card {
  background: #111827;
  border-radius: 12px;
  padding: 8px 8px 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}

/* Media */
.card-media {
  position: relative;
  margin-bottom: 6px;
}
.card img,
.card video {
  width: 100%;
  border-radius: 8px;
  display: block;
}
.card img {
  cursor: zoom-in; /* zoom option */
}

/* Simple play hint overlay for videos */
.video-play-hint {
  position: absolute;
  right: 8px;
  bottom: 8px;
  background: rgba(15,23,42,0.7);
  border-radius: 999px;
  padding: 2px 7px;
  font-size: 11px;
  color: #e5e7eb;
}

/* Header / text */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 8px;
}
.card-title {
  font-weight: 700;
  font-size: 15px;
}
.card-status {
  font-size: 13px;
  color: #bfdbfe;
  text-align: right;
  cursor: pointer; /* clickable */
}
.card-answer {
  font-size: 14px;
  margin-top: 4px;
}
.card-date {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 2px;
}

/* Footer buttons */
.card-footer {
  margin-top: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.card-footer-left {
  display: flex;
  gap: 6px;
}
.card-footer button {
  background: #4b5563;
  border: 1px solid #374151;
  border-radius: 999px;
  padding: 5px 10px;
  color: #f9fafb;
  font-weight: 600;
  cursor: pointer;
  font-size: 12px;
}
.card-footer button[disabled] {
  opacity: 0.5;
  cursor: default;
}
.card-footer-right {
  margin-left: auto;
  display: flex;
  gap: 6px;
}
.card-footer-right button {
  font-size: 11px;
  padding: 4px 8px;
}

.empty {
  text-align: center;
  font-size: 14px;
  margin-top: 20px;
}

/* Zoom overlay */
#zoomOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  cursor: zoom-out;
}
#zoomOverlay.hidden {
  display: none;
}
#zoomInner {
  width: 100vw;
  height: 100vh;
  padding: 16px;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}
#zoomInner img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 12px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.8);
}
#zoomCaption {
  position: absolute;
  left: 50%;
  bottom: 10px;
  transform: translateX(-50%);
  color: #e5e7eb;
  font-size: 12px;
  background: rgba(15,23,42,0.7);
  padding: 4px 8px;
  border-radius: 999px;
}
</style>
</head>
<body>

<script src="puzzles.js?v=2"></script>

<div class="shell">
  <div id="top-bar">
    <h1>Gallery</h1>
    <button id="backButton">Back to game</button>
  </div>

  <div id="intro">
    Browse all LOSWords puzzles. See the ones you've played and jump into new ones.
  </div>

  <div id="viewControls" aria-label="View options">
    <button id="tilesViewBtn" class="view-toggle" data-view="tiles">Tiles</button>
    <button id="listViewBtn" class="view-toggle view-toggle-active" data-view="list">List</button>
  </div>

  <div id="gallery" class="list-view"></div>
  <div id="emptyMessage" class="empty" style="display:none;">
    No puzzles found. Check your <code>puzzles.js</code> file.
  </div>
</div>

<!-- Zoom overlay for images -->
<div id="zoomOverlay" class="hidden">
  <div id="zoomInner">
    <img id="zoomImg" src="" alt="" />
    <div id="zoomCaption">Tap / click anywhere to close</div>
  </div>
</div>

<script>
const STORAGE_KEY = "loswords-stats-v1";
const puzzles = window.puzzles || [];

/* ---------- TODAY INDEX (match main game logic) ---------- */
// Same as in index.html: daily puzzle index based on epoch + modulo.
function getDailyIndex() {
  if (!puzzles.length) return 0;
  const epoch = new Date(2025, 0, 1);  // 1 Jan 2025
  const today = new Date();
  epoch.setHours(0, 0, 0, 0);
  today.setHours(0, 0, 0, 0);
  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.floor((today - epoch) / msPerDay);
  const idx = ((diffDays % puzzles.length) + puzzles.length) % puzzles.length;
  return idx;
}

const TODAY_INDEX = getDailyIndex();

/* THIS is the important bit:
   Puzzle date = today's date + (puzzleIndex - TODAY_INDEX) days.
   This matches index.html's getDateForIndex, so gallery dates line up
   with what the main game shows. */
function getPuzzleDateForIndex(index) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const d = new Date(today);
  d.setDate(d.getDate() + (index - TODAY_INDEX));
  return d;
}

/* ---------- STATS ---------- */
function loadStats() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return {};
    return JSON.parse(raw);
  } catch {
    return {};
  }
}

function getPuzzleKey(p, index) {
  if (p.id != null) return String(p.id);
  return "index-" + index;
}

/* ---------- NAVIGATION TO MAIN GAME ---------- */
function goToPuzzle(puzzle, index) {
  // If this puzzle is in the future, block play but allow postcard / buy
  if (index > TODAY_INDEX) {
    const d = getPuzzleDateForIndex(index);
    const label = d.toLocaleDateString(undefined, {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric"
    });
    alert(
      "This LOSWords puzzle is not live yet.\n\n" +
      "It unlocks on " + label + ".\n\n" +
      "You can still build a postcard or buy this image in the meantime."
    );
    return;
  }

  // Otherwise deep-link into index.html
  if (puzzle.id != null) {
    window.location.href =
      "index.html?puzzleId=" + encodeURIComponent(puzzle.id);
  } else {
    window.location.href =
      "index.html?puzzleIndex=" + encodeURIComponent(index);
  }
}

/* ---------- ZOOM OVERLAY ---------- */
const zoomOverlay = document.getElementById("zoomOverlay");
const zoomImg = document.getElementById("zoomImg");

function openZoom(src, altText) {
  zoomImg.src = src;
  zoomImg.alt = altText || "";
  zoomOverlay.classList.remove("hidden");
}

zoomOverlay.addEventListener("click", () => {
  zoomOverlay.classList.add("hidden");
  zoomImg.src = "";
});

/* ---------- VIEW TOGGLES (tiles / list) ---------- */
const galleryEl = document.getElementById("gallery");
const tilesViewBtn = document.getElementById("tilesViewBtn");
const listViewBtn = document.getElementById("listViewBtn");

function setView(mode) {
  galleryEl.classList.remove("tiles-view", "list-view");
  tilesViewBtn.classList.remove("view-toggle-active");
  listViewBtn.classList.remove("view-toggle-active");

  if (mode === "tiles") {
    galleryEl.classList.add("tiles-view");
    tilesViewBtn.classList.add("view-toggle-active");
  } else {
    galleryEl.classList.add("list-view");
    listViewBtn.classList.add("view-toggle-active");
  }
}

tilesViewBtn.addEventListener("click", () => setView("tiles"));
listViewBtn.addEventListener("click", () => setView("list"));

/* ---------- VIDEO AUTOPLAY / TAP PLAY HELPERS ---------- */
const galleryVideos = [];

function attachVideoBehaviour(video) {
  // Basic safe defaults for mobile
  video.muted = true;
  video.playsInline = true;
  video.loop = true;
  video.autoplay = true;

  // Try autoplay immediately
  video.play().catch(() => { /* mobile may require tap */ });

  // Toggle play/pause on tap
  video.addEventListener("click", () => {
    if (video.paused) {
      video.play().catch(() => {});
    } else {
      video.pause();
    }
  });

  galleryVideos.push(video);
}

// Once the user interacts with the page (first tap/click), try to start all videos
function attemptAutoplayVideos() {
  galleryVideos.forEach(v => {
    if (v.paused) {
      v.play().catch(() => {});
    }
  });
}
document.addEventListener("touchstart", attemptAutoplayVideos, { once: true });
document.addEventListener("click", attemptAutoplayVideos, { once: true });

/* ---------- RENDER GALLERY ---------- */
function renderGallery() {
  const stats = loadStats();
  const completed = (stats && stats.completed) || {};
  const emptyMessage = document.getElementById("emptyMessage");

  galleryEl.innerHTML = "";
  galleryVideos.length = 0; // reset list

  if (!puzzles.length) {
    emptyMessage.style.display = "block";
    return;
  } else {
    emptyMessage.style.display = "none";
  }

  puzzles.forEach((puzzle, index) => {
    const card = document.createElement("div");
    card.className = "card";

    const key = getPuzzleKey(puzzle, index);
    const entry = completed[key] || null;
    const isFuture = index > TODAY_INDEX;

    /* ----- MEDIA ----- */
    const mediaFile = puzzle.image;
    if (mediaFile) {
      const mediaWrap = document.createElement("div");
      mediaWrap.className = "card-media";

      if (typeof mediaFile === "string" &&
          mediaFile.toLowerCase().endsWith(".mp4")) {
        const vid = document.createElement("video");
        vid.src = mediaFile;
        vid.preload = "metadata";
        mediaWrap.appendChild(vid);

        const hint = document.createElement("div");
        hint.className = "video-play-hint";
        hint.textContent = "Tap to play";
        mediaWrap.appendChild(hint);

        attachVideoBehaviour(vid);
      } else {
        const img = document.createElement("img");
        img.src = mediaFile;
        img.alt = puzzle.clue || "";
        img.addEventListener("click", () => {
          openZoom(mediaFile, puzzle.clue || "LOSWords image");
        });
        mediaWrap.appendChild(img);
      }

      card.appendChild(mediaWrap);
    }

    /* ----- HEADER ----- */
    const header = document.createElement("div");
    header.className = "card-header";

    const title = document.createElement("div");
    const num = puzzle.id != null ? puzzle.id : (index + 1);
    title.className = "card-title";
    title.textContent = "LOSWords #" + num;
    header.appendChild(title);

    const status = document.createElement("div");
    status.className = "card-status";

    if (isFuture) {
      status.textContent = "Status: Unlocks soon";
    } else if (entry && entry.played) {
      status.textContent = entry.won ? "Status: Won" : "Status: Played";
    } else {
      status.textContent = "Status: Not played";
    }

    status.addEventListener("click", () => {
      goToPuzzle(puzzle, index);
    });

    header.appendChild(status);
    card.appendChild(header);

    /* ----- DATE (now matches main game) ----- */
    const dateEl = document.createElement("div");
    dateEl.className = "card-date";
    const d = getPuzzleDateForIndex(index);
    dateEl.textContent = d.toLocaleDateString(undefined, {
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "numeric"
    });
    card.appendChild(dateEl);

    /* ----- ANSWER ----- */
    const answer = document.createElement("div");
    answer.className = "card-answer";
    if (entry && entry.played) {
      answer.textContent = "Answer: " + puzzle.answer;
    } else if (isFuture) {
      answer.textContent = "Answer: ??? (unlocks on this date)";
    } else {
      answer.textContent = "Answer: ??? (play to reveal)";
    }
    card.appendChild(answer);

    /* ----- FOOTER BUTTONS ----- */
    const footer = document.createElement("div");
    footer.className = "card-footer";

    const footerLeft = document.createElement("div");
    footerLeft.className = "card-footer-left";

    const playBtn = document.createElement("button");
    playBtn.textContent = "Play this puzzle";
    playBtn.addEventListener("click", () => {
      goToPuzzle(puzzle, index);
    });
    footerLeft.appendChild(playBtn);
    footer.appendChild(footerLeft);

    const footerRight = document.createElement("div");
    footerRight.className = "card-footer-right";

    const postcardBtn = document.createElement("button");
    postcardBtn.textContent = "Build postcard";
    postcardBtn.addEventListener("click", () => {
      // Hook this up to your postcard builder when you have one
      alert("This will eventually let you build a postcard from this image.");
    });
    footerRight.appendChild(postcardBtn);

    const buyBtn = document.createElement("button");
    buyBtn.textContent = "Buy this image";
    buyBtn.addEventListener("click", () => {
      // Hook this up to your store / checkout
      alert("This will eventually link to a store to buy this image.");
    });
    footerRight.appendChild(buyBtn);

    footer.appendChild(footerRight);
    card.appendChild(footer);

    galleryEl.appendChild(card);
  });
}

/* ---------- BACK BUTTON ---------- */
document.getElementById("backButton").addEventListener("click", () => {
  window.location.href = "index.html";
});

/* ---------- INIT ---------- */
setView("list");
renderGallery();
</script>

</body>
</html>
