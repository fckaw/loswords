<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LOSWords</title>

<style>
/* Basic layout â€“ medium grey background */
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #6b7280;           /* medium grey */
  color: #e5e7eb;                /* soft light grey */
  margin: 0;
  padding: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Top bar with title + stats button */
#top-bar {
  width: 100%;
  max-width: 420px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 6px 0 4px;
}

/* Title */
h1#title {
  margin: 0;
  flex: 1;
  font-size: 7vw;
  text-align: center;
  letter-spacing: 0.06em;
}
@media (min-width: 480px) {
  h1#title { font-size: 28px; }
}

/* Today's / puzzle date label */
#today {
  width: 100%;
  max-width: 420px;
  text-align: center;
  font-size: 13px;
  color: #f9fafb;
  margin-bottom: 4px;
}

/* Archive nav */
#nav {
  width: 100%;
  max-width: 420px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}
#nav button {
  background: #4b5563;
  border: 1px solid #374151;
  border-radius: 999px;
  padding: 5px 12px;
  color: #f9fafb;
  font-weight: 600;
  cursor: pointer;
  font-size: 13px;
}
#nav button:disabled {
  opacity: 0.4;
  cursor: default;
}

/* Stats button */
#statsButton {
  background: #4b5563;
  border: 1px solid #374151;
  border-radius: 999px;
  padding: 6px 10px;
  color: #f9fafb;
  font-weight: 600;
  cursor: pointer;
  font-size: 3.3vw;
}
@media (min-width: 480px) {
  #statsButton { font-size: 14px; }
}
#statsButton:focus-visible {
  outline: 2px solid #facc15;
  outline-offset: 2px;
}

/* Clue + instructions */
#clue {
  color: #e5e7ff;
  text-align: center;
  margin-top: 6px;
  margin-bottom: 12px;
  font-size: 3.7vw;
  max-width: 420px;
  line-height: 1.5;
}
@media (min-width: 480px) { #clue { font-size: 16px; } }

#clue .instruction {
  display: block;
  margin-top: 4px;
  color: #f9fafb;
  font-size: 3.4vw;
}
@media (min-width: 480px) { #clue .instruction { font-size: 15px; } }

/* Media */
#meme-image,
#meme-video {
  width: 100%;
  max-width: 340px;
  border-radius: 12px;
  margin-bottom: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}

/* Grid container */
#grid {
  width: 100%;
  max-width: 420px;
  margin: 0 auto;
}

/* PHRASE MODE â€“ widened gap between words */
.phrase-container {
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 18px;                     /* big gap BETWEEN words */
  justify-content: center;
  margin-top: 4px;
}
.phrase-word {
  display: flex;
  gap: 4px;                      /* small gap BETWEEN letters */
}
.phrase-tile {
  width: min(8vw, 40px);
  height: min(8vw, 40px);
  border: 2px solid #4b5563;
  background: #1f2937;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: min(4.7vw, 19px);
  font-weight: bold;
  text-transform: uppercase;
  box-sizing: border-box;
  border-radius: 6px;
}
.fixed {
  background: #111827;
  border-color: #1f2937;
  color: #d1d5db;
}
.revealed {
  background: #22c55e;
  border-color: #22c55e;
  color: #0b1120;
}

/* Lives & messages */
#lives {
  margin-top: 4px;
  font-size: 3.7vw;
  color: #f9fafb;
}
@media (min-width: 480px) { #lives { font-size: 15px; } }

#message {
  margin-top: 10px;
  min-height: 22px;
  text-align: center;
  color: #facc15;
  font-size: 4vw;
}
@media (min-width: 480px) { #message { font-size: 16px; } }

/* Keyboard */
#keyboard {
  margin-top: 18px;
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.key-row {
  display: flex;
  justify-content: center;
  gap: 6px;
}
.key {
  background: #374151;
  color: #f9fafb;
  border: none;
  border-radius: 999px;
  font-weight: 600;
  text-align: center;
  padding: 10px 8px;
  min-width: 32px;
  max-width: 42px;
  font-size: 3.5vw;
  cursor: pointer;
}
@media (min-width: 480px) { .key { font-size: 15px; } }
.key.correct { background: #22c55e; color: #020617; }
.key.present { background: #eab308; color: #020617; }
/* WRONG LETTERS IN YELLOW */
.key.absent  { background: #eab308; color: #020617; }

/* Hidden input (for capturing keyboard focus on mobile) */
#hiddenInput {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
  border: 0;
  padding: 0;
}

/* Stats / end-of-game modal */
.modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(15, 23, 42, 0.75);
  z-index: 50;
}
.modal.hidden {
  display: none;
}
.modal-content {
  background: #020617;
  border-radius: 16px;
  padding: 20px 22px 24px;
  width: 90%;
  max-width: 340px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.7);
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: center; /* center title */
  margin-bottom: 8px;
  position: relative;
}
/* BIG, CENTRED TITLE */
.modal-header h2 {
  margin: 0;
  font-size: 24px;
  text-align: center;
}
.modal-close {
  background: transparent;
  border: none;
  color: #9ca3af;
  font-size: 22px;
  cursor: pointer;
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
}
#endText {
  margin: 6px 0 12px;
  font-size: 15px;
  color: #e5e7eb;
  text-align: center;
}

/* Stats in modal â€“ BLUE BOXES */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px;
  text-align: center;
  margin-top: 6px;
}
.stat {
  padding: 8px 4px;
  border-radius: 10px;
  background: #1d4ed8;   /* blue */
  border: 1px solid #1e40af;
}
.stat-value {
  font-size: 20px;
  font-weight: 700;
}
.stat-label {
  font-size: 12px;
  color: #dbeafe;
  margin-top: 3px;
}
</style>
</head>

<body>

<!-- still using your existing puzzles.js -->
<script src="puzzles.js?v=2"></script>

<div id="top-bar">
  <h1 id="title">LOSWords</h1>
  <button id="statsButton" aria-label="View stats">ðŸ“Š</button>
</div>

<div id="today"></div>

<div id="nav">
  <button id="prevBtn">&larr; Prev</button>
  <button id="nextBtn">Next &rarr;</button>
</div>

<div id="clue"></div>

<img id="meme-image" style="display:none" alt="" />
<video id="meme-video" playsinline muted loop style="display:none"></video>

<div id="grid"></div>
<div id="lives"></div>
<div id="keyboard"></div>
<div id="message"></div>

<input id="hiddenInput" type="text"
       autocomplete="off" autocorrect="off"
       autocapitalize="none" spellcheck="false" />

<!-- Stats / end-of-game modal -->
<div id="statsModal" class="modal hidden" aria-modal="true" role="dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="statsTitle">Stats</h2>
      <button id="closeStats" class="modal-close" aria-label="Close stats">&times;</button>
    </div>
    <p id="endText"></p>
    <div class="stats-grid">
      <div class="stat">
        <div class="stat-value" id="stat-played">0</div>
        <div class="stat-label">Played</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-win">0</div>
        <div class="stat-label">Win&nbsp;%</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-current">0</div>
        <div class="stat-label">Current<br />streak</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-max">0</div>
        <div class="stat-label">Max<br />streak</div>
      </div>
    </div>
  </div>
</div>

<script>
/************* PUZZLES *************/
const puzzles = window.puzzles || [];

/************* CONSTANTS *************/
const MAX_WRONG = 8;                      // 8 wrong guesses
const STORAGE_KEY = "loswords-stats-v1";

/************* STATE & DOM *************/
let currentIndex = 0;
let todayIndex = 0;
let gameOver = false;

const titleEl     = document.getElementById("title");
const clueEl      = document.getElementById("clue");
const imgEl       = document.getElementById("meme-image");
const videoEl     = document.getElementById("meme-video");
const gridEl      = document.getElementById("grid");
const livesEl     = document.getElementById("lives");
const keyboardEl  = document.getElementById("keyboard");
const messageEl   = document.getElementById("message");
const hiddenInput = document.getElementById("hiddenInput");
const todayEl     = document.getElementById("today");

const statsButton = document.getElementById("statsButton");
const statsModal  = document.getElementById("statsModal");
const closeStats  = document.getElementById("closeStats");
const statsTitle  = document.getElementById("statsTitle");
const endTextEl   = document.getElementById("endText");

const prevBtn     = document.getElementById("prevBtn");
const nextBtn     = document.getElementById("nextBtn");

/************* DATE LABEL (per puzzle index) *************/
/* Figure out the calendar date for a given puzzle index,
   based on how far it is from today's index. */
function getDateForIndex(index) {
  const today = new Date();
  const diff = index - todayIndex; // how many days away from today
  const d = new Date(today);
  d.setDate(d.getDate() + diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

function updateDateLabel() {
  if (!puzzles.length) {
    todayEl.textContent = "";
    return;
  }
  const d = getDateForIndex(currentIndex);
  const label = d.toLocaleDateString(undefined, {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric"
  });

  if (currentIndex === todayIndex) {
    todayEl.textContent = `${label} â€“ Today's puzzle`;
  } else {
    todayEl.textContent = `${label} â€“ Archive puzzle`;
  }
}

/************* MEDIA *************/
function showMedia(file) {
  if (!file) {
    imgEl.style.display = "none";
    videoEl.style.display = "none";
    return;
  }
  const lower = file.toLowerCase();
  if (lower.endsWith(".mp4")) {
    imgEl.style.display = "none";
    videoEl.style.display = "block";
    videoEl.src = file;
    videoEl.play().catch(()=>{});
  } else {
    videoEl.style.display = "none";
    videoEl.pause();
    imgEl.style.display = "block";
    imgEl.src = file;
  }
}

/************* KEYBOARD *************/
const keyButtons = {};
const keyboardLayout = [
  ["Q","W","E","R","T","Y","U","I","O","P"],
  ["A","S","D","F","G","H","J","K","L"],
  ["Z","X","C","V","B","N","M"]
];

function buildKeyboard() {
  keyboardEl.innerHTML = "";
  keyboardLayout.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.className = "key-row";

    row.forEach(key => {
      const btn = document.createElement("button");
      btn.classList.add("key");
      btn.textContent = key;
      btn.dataset.key = key;

      btn.addEventListener("click", () => {
        handleKeyPress(key);
        hiddenInput.focus();
      });

      keyButtons[key] = btn;
      rowDiv.appendChild(btn);
    });

    keyboardEl.appendChild(rowDiv);
  });
}

function resetKeyboard() {
  for (let k in keyButtons) {
    keyButtons[k].classList.remove("correct","present","absent");
  }
}

function setKeyStatus(letter, status) {
  const key = letter.toUpperCase();
  const btn = keyButtons[key];
  if (!btn) return;

  if (status === "correct") {
    btn.classList.remove("present","absent");
    btn.classList.add("correct");
  } else if (status === "present") {
    if (!btn.classList.contains("correct")) {
      btn.classList.remove("absent");
      btn.classList.add("present");
    }
  } else if (status === "absent") {
    if (!btn.classList.contains("correct") &&
        !btn.classList.contains("present")) {
      btn.classList.add("absent");
    }
  }
}

/************* PHRASE MODE ONLY *************/
let pAnswer = "";
let pTiles = [];
let pRevealed = {};
let pGuessed = new Set();
let pUnique = 0;
let pWrong = 0;

function setupPhrase(p) {
  pAnswer = p.answer.toLowerCase();
  pTiles = [];
  pRevealed = {};
  pGuessed.clear();
  pWrong = 0;

  const letters = new Set();
  for (let ch of pAnswer) {
    if (/[a-z]/.test(ch)) letters.add(ch);
  }
  pUnique = letters.size;

  const wrapper = document.createElement("div");
  wrapper.className = "phrase-container";

  let group = null;

  for (let i = 0; i < pAnswer.length; i++) {
    const ch = pAnswer[i];

    if (ch === " ") {
      group = null;      // new word â€“ bigger gap between words
      pTiles[i] = null;
      continue;
    }

    if (!group) {
      group = document.createElement("div");
      group.className = "phrase-word";
      wrapper.appendChild(group);
    }

    const tile = document.createElement("div");
    tile.className = "phrase-tile";

    if (/[a-z]/.test(ch)) {
      tile.textContent = "";
    } else {
      tile.classList.add("fixed");
      tile.textContent = ch;
    }

    group.appendChild(tile);
    pTiles[i] = tile;

    if (ch === "-") {
      group = null;      // allow wrapping after hyphens
    }
  }

  gridEl.appendChild(wrapper);
  updateLives();
}

function handlePhraseKey(letter) {
  if (gameOver) return;

  const l = letter.toLowerCase();
  if (!/[a-z]/.test(l)) return;

  // If already guessed this letter
  if (pGuessed.has(l)) {
    // If it was a wrong letter, show alert + message
    if (!pAnswer.includes(l)) {
      const msg = `${letter.toUpperCase()} is not in the phrase and has already been guessed.`;
      alert(msg);
      showMessage(msg);
    }
    return;
  }

  pGuessed.add(l);

  if (pAnswer.includes(l)) {
    pAnswer.split("").forEach((ch, i) => {
      if (ch === l && pTiles[i]) {
        pTiles[i].classList.add("revealed");
        pTiles[i].textContent = letter.toUpperCase();
      }
    });

    setKeyStatus(letter, "correct");
    pRevealed[l] = true;

    if (Object.keys(pRevealed).length === pUnique) {
      showMessage("Solved! ðŸŽ‰");
      gameOver = true;
      const isToday = currentIndex === todayIndex;
      recordResult(true, isToday);
      openEndModal(true, isToday);
    }
  } else {
    pWrong++;
    setKeyStatus(letter, "absent");
    updateLives();
    if (pWrong >= MAX_WRONG) {
      showMessage("Out of guesses! " + pAnswer.toUpperCase());
      gameOver = true;
      revealFullAnswer();
      const isToday = currentIndex === todayIndex;
      recordResult(false, isToday);
      openEndModal(false, isToday);
    }
  }
}

function updateLives() {
  livesEl.textContent = `Wrong guesses: ${pWrong} / ${MAX_WRONG}`;
}

function revealFullAnswer() {
  pAnswer.split("").forEach((ch, i) => {
    if (/[a-z]/.test(ch) && pTiles[i]) {
      pTiles[i].classList.add("revealed");
      pTiles[i].textContent = ch.toUpperCase();
    }
  });
}

/************* INPUT *************/
function handleKeyPress(k) {
  if (gameOver) return;
  const key = k.toUpperCase();
  if (/^[A-Z]$/.test(key)) {
    handlePhraseKey(key);
  }
}

document.addEventListener("keydown", e => {
  if (/^[a-zA-Z]$/.test(e.key)) {
    handleKeyPress(e.key);
  }
});

document.body.addEventListener("click", () => hiddenInput.focus());

/************* DAILY PUZZLE LOGIC *************/
function getTodayKey() {
  const d = new Date();
  const year  = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day   = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

function getDailyIndex() {
  if (!puzzles.length) return 0;
  const epoch = new Date(2025, 0, 1);  // 1 Jan 2025 local
  const today = new Date();

  epoch.setHours(0,0,0,0);
  today.setHours(0,0,0,0);

  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.floor((today - epoch) / msPerDay);

  // Support dates before epoch too
  const idx = ((diffDays % puzzles.length) + puzzles.length) % puzzles.length;
  return idx;
}

/************* STATS *************/
function loadStats() {
  const defaults = {
    gamesPlayed: 0,
    wins: 0,
    currentStreak: 0,
    maxStreak: 0,
    lastPlayedDate: null,
    lastResult: null
  };
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return {...defaults};
    const parsed = JSON.parse(raw);
    return {...defaults, ...parsed};
  } catch {
    return {...defaults};
  }
}

function saveStats(stats) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
  } catch {
    // ignore storage errors
  }
}

/*
  All finished games increment:
   - gamesPlayed
   - wins (if didWin)

  Only today's game (isToday === true) affects:
   - currentStreak
   - maxStreak
   - lastPlayedDate / lastResult
*/
function recordResult(didWin, isToday) {
  const stats = loadStats();
  const todayKey = getTodayKey();

  // Count every finished game towards Played & Wins
  stats.gamesPlayed += 1;
  if (didWin) {
    stats.wins += 1;
  }

  if (isToday) {
    if (stats.lastPlayedDate !== todayKey) {
      // Only update streak once per day
      if (didWin) {
        if (stats.lastPlayedDate && stats.lastResult === "win") {
          stats.currentStreak += 1;
        } else {
          stats.currentStreak = 1;
        }
        if (stats.currentStreak > stats.maxStreak) {
          stats.maxStreak = stats.currentStreak;
        }
        stats.lastResult = "win";
      } else {
        stats.currentStreak = 0;
        stats.lastResult = "loss";
      }
      stats.lastPlayedDate = todayKey;
    }
  }

  saveStats(stats);
}

function updateStatsUI() {
  const stats = loadStats();
  const winPct = stats.gamesPlayed
    ? Math.round((stats.wins / stats.gamesPlayed) * 100)
    : 0;

  document.getElementById("stat-played").textContent  = stats.gamesPlayed;
  document.getElementById("stat-win").textContent     = winPct;
  document.getElementById("stat-current").textContent = stats.currentStreak;
  document.getElementById("stat-max").textContent     = stats.maxStreak;
}

/************* END-OF-GAME MODAL *************/
function openEndModal(didWin, isToday) {
  updateStatsUI();

  if (didWin) {
    statsTitle.textContent = "ðŸŽ‰ Congratulations!";
    endTextEl.textContent =
      (isToday
        ? "You solved today's LOSWords. See you tomorrow!"
        : "You solved this archive LOSWords. Come back tomorrow for a new one!");
  } else {
    statsTitle.textContent = "ðŸ˜… Good try!";
    endTextEl.textContent =
      (isToday
        ? `The answer was: ${pAnswer.toUpperCase()}. See you tomorrow!`
        : `The answer was: ${pAnswer.toUpperCase()}. This was an archive LOSWords puzzle.`);
  }

  statsModal.classList.remove("hidden");
}

/************* NAV BUTTONS (ARCHIVE) *************/
function updateNavButtons() {
  if (!puzzles.length) {
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    return;
  }

  // Earliest puzzle is index 0
  prevBtn.disabled = currentIndex <= 0;

  // Latest playable archive is today's puzzle
  nextBtn.disabled = currentIndex >= todayIndex;
}

prevBtn.addEventListener("click", () => {
  if (currentIndex > 0) {
    currentIndex -= 1;
    loadPuzzle(currentIndex);
    updateNavButtons();
  }
});

nextBtn.addEventListener("click", () => {
  if (currentIndex < todayIndex) {
    currentIndex += 1;
    loadPuzzle(currentIndex);
    updateNavButtons();
  }
});

/************* LOADING PUZZLE *************/
function loadPuzzle(index) {
  if (!puzzles.length) {
    titleEl.textContent = "LOSWords";
    clueEl.textContent  = "No puzzles loaded. Check puzzles.js.";
    gridEl.innerHTML    = "";
    showMedia(null);
    return;
  }

  const p = puzzles[index % puzzles.length];
  gameOver = false;

  resetKeyboard();
  gridEl.innerHTML = "";
  messageEl.textContent = "";
  livesEl.textContent = "";
  endTextEl.textContent = "";
  statsTitle.textContent = "Stats";

  const number = p.id != null ? p.id : (index + 1);
  titleEl.textContent = "LOSWords #" + number;

  showMedia(p.image);

  clueEl.innerHTML =
    p.clue +
    `<br><span class="instruction">Guess the phrase one letter at a time. You have ${MAX_WRONG} wrong guesses.</span>`;

  setupPhrase(p);

  // Update the date label for this puzzle
  updateDateLabel();

  // Only lock if it's today's puzzle and already played today
  const stats = loadStats();
  const todayKey = getTodayKey();
  if (index === todayIndex && stats.lastPlayedDate === todayKey) {
    revealFullAnswer();
    gameOver = true;
    showMessage("You've already played today's LOSWORDS. Come back tomorrow!");
  }

  setTimeout(() => hiddenInput.focus(), 50);
}

/************* STATS MODAL EVENTS *************/
statsButton.addEventListener("click", () => {
  // Plain stats view
  statsTitle.textContent = "Stats";
  endTextEl.textContent = "";
  updateStatsUI();
  statsModal.classList.remove("hidden");
});

closeStats.addEventListener("click", () => {
  statsModal.classList.add("hidden");
});

statsModal.addEventListener("click", (e) => {
  if (e.target === statsModal) {
    statsModal.classList.add("hidden");
  }
});

/************* START *************/
buildKeyboard();
todayIndex = getDailyIndex();
currentIndex = todayIndex;
loadPuzzle(currentIndex);
updateNavButtons();

function showMessage(msg) {
  messageEl.textContent = msg;
}
</script>

</body>
</html>
