<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LOSWords</title>

<style>
/* Basic layout â€“ medium grey background */
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #6b7280;           /* medium grey */
  color: #e5e7eb;                /* soft light grey */
  margin: 0;
  padding: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Dyslexia-friendly font */
body.dyslexia-font {
  font-family: "OpenDyslexic", "Comic Sans MS", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* High contrast mode */
body.high-contrast {
  background: #000000;
  color: #ffffff;
}
body.high-contrast #nav button,
body.high-contrast #statsButton,
body.high-contrast #accessibilityButton,
body.high-contrast #onboardingButton,
body.high-contrast #galleryButton,
body.high-contrast .modal-actions button {
  background: #000000;
  color: #ffffff;
  border-color: #ffffff;
}
body.high-contrast .phrase-tile {
  background: #000000;
  border-color: #ffffff;
  color: #ffffff;
}
body.high-contrast .phrase-tile.revealed {
  background: #ffffff;
  color: #000000;
}
body.high-contrast .key {
  background: #111827;
  color: #f9fafb;
}
body.high-contrast .key.correct {
  background: #22c55e;
  color: #020617;
}
body.high-contrast .key.present,
body.high-contrast .key.absent {
  background: #eab308;
  color: #020617;
}
body.high-contrast .stat {
  background: #000000;
  border-color: #ffffff;
}
body.high-contrast .modal-content {
  background: #000000;
}

/* Top bar with title */
#top-bar {
  width: 100%;
  max-width: 420px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 6px 0 4px;
}

/* Title */
h1#title {
  margin: 0;
  flex: 1;
  font-size: 7vw;
  text-align: center;
  letter-spacing: 0.06em;
}
@media (min-width: 480px) {
  h1#title { font-size: 28px; }
}

/* Puzzle date label */
#today {
  width: 100%;
  max-width: 420px;
  text-align: center;
  font-size: 13px;
  color: #f9fafb;
  margin-bottom: 4px;
}

/* Archive nav */
#nav {
  width: 100%;
  max-width: 420px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}
#nav button {
  background: #4b5563;
  border: 1px solid #374151;
  border-radius: 999px;
  padding: 5px 12px;
  color: #f9fafb;
  font-weight: 600;
  cursor: pointer;
  font-size: 13px;
}
#nav button:disabled {
  opacity: 0.4;
  cursor: default;
}

/* Center buttons between Prev / Next */
#nav-center {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
}
#nav-center button {
  font-size: 13px;
  padding-inline: 10px;
}

/* Stats button */
#statsButton {
  background: #4b5563;
  border: 1px solid #374151;
  border-radius: 999px;
  padding: 6px 10px;
  color: #f9fafb;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}
#statsButton:focus-visible,
#accessibilityButton:focus-visible,
#onboardingButton:focus-visible,
#galleryButton:focus-visible {
  outline: 2px solid #facc15;
  outline-offset: 2px;
}

/* Clue + instructions */
#clue {
  color: #e5e7ff;
  text-align: center;
  margin-top: 6px;
  margin-bottom: 12px;
  font-size: 3.7vw;
  max-width: 420px;
  line-height: 1.5;
}
@media (min-width: 480px) { #clue { font-size: 16px; } }

#clue .instruction {
  display: block;
  margin-top: 4px;
  color: #f9fafb;
  font-size: 3.4vw;
}
@media (min-width: 480px) { #clue .instruction { font-size: 15px; } }

/* Media */
#meme-image,
#meme-video {
  width: 100%;
  max-width: 340px;
  border-radius: 12px;
  margin-bottom: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}

/* Grid container */
#grid {
  width: 100%;
  max-width: 420px;
  margin: 0 auto;
}

/* PHRASE MODE â€“ widened gap between words */
.phrase-container {
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 18px;                     /* big gap BETWEEN words */
  justify-content: center;
  margin-top: 4px;
}
.phrase-word {
  display: flex;
  gap: 4px;                      /* small gap BETWEEN letters */
}
.phrase-tile {
  width: min(8vw, 40px);
  height: min(8vw, 40px);
  border: 2px solid #4b5563;
  background: #1f2937;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: min(4.7vw, 19px);
  font-weight: bold;
  text-transform: uppercase;
  box-sizing: border-box;
  border-radius: 6px;
}
.fixed {
  background: #111827;
  border-color: #1f2937;
  color: #d1d5db;
}
.revealed {
  background: #22c55e;
  border-color: #22c55e;
  color: #0b1120;
}

/* Lives & messages */
#lives {
  margin-top: 4px;
  font-size: 3.7vw;
  color: #f9fafb;
}
@media (min-width: 480px) { #lives { font-size: 15px; } }

#message {
  margin-top: 10px;
  min-height: 22px;
  text-align: center;
  color: #facc15;
  font-size: 4vw;
}
@media (min-width: 480px) { #message { font-size: 16px; } }

/* Keyboard */
#keyboard {
  margin-top: 18px;
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.key-row {
  display: flex;
  justify-content: center;
  gap: 6px;
}
.key {
  background: #374151;
  color: #f9fafb;
  border: none;
  border-radius: 999px;
  font-weight: 600;
  text-align: center;
  padding: 10px 8px;
  min-width: 32px;
  max-width: 42px;
  font-size: 3.5vw;
  cursor: pointer;
}
@media (min-width: 480px) { .key { font-size: 15px; } }
.key.correct { background: #22c55e; color: #020617; }
.key.present { background: #eab308; color: #020617; }
/* WRONG LETTERS IN YELLOW */
.key.absent  { background: #eab308; color: #020617; }

/* Hidden input (for capturing keyboard focus on mobile) */
#hiddenInput {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
  border: 0;
  padding: 0;
}

/* Modal base */
.modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(15, 23, 42, 0.75);
  z-index: 50;
}
.modal.hidden {
  display: none;
}
.modal-content {
  background: #020617;
  border-radius: 16px;
  padding: 20px 22px 24px;
  width: 90%;
  max-width: 340px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.7);
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: center; /* center title */
  margin-bottom: 8px;
  position: relative;
}
/* BIG, CENTRED TITLE */
.modal-header h2 {
  margin: 0;
  font-size: 24px;
  text-align: center;
}
.modal-close {
  background: transparent;
  border: none;
  color: #9ca3af;
  font-size: 22px;
  cursor: pointer;
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
}
#endText {
  margin: 6px 0 12px;
  font-size: 15px;
  color: #e5e7eb;
  text-align: center;
}

.modal-subtitle {
  margin: 0 0 8px;
  font-size: 14px;
  color: #9ca3af;
}

/* Stats in modal â€“ BLUE BOXES */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px;
  text-align: center;
  margin-top: 6px;
}
.stat {
  padding: 8px 4px;
  border-radius: 10px;
  background: #1d4ed8;   /* blue */
  border: 1px solid #1e40af;
}
.stat-value {
  font-size: 20px;
  font-weight: 700;
}
.stat-label {
  font-size: 12px;
  color: #dbeafe;
  margin-top: 3px;
}

/* Achievements */
#achievementsSection {
  margin-top: 14px;
  border-top: 1px solid #1f2937;
  padding-top: 10px;
}
#achievementsTitle {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  text-align: left;
}
#achievementsList {
  margin-top: 6px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.achievement-badge {
  background: #111827;
  border-radius: 999px;
  padding: 4px 8px;
  font-size: 12px;
  white-space: nowrap;
}

/* Modal actions (share / tip / subscribe) */
.modal-actions {
  margin-top: 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.modal-actions button {
  background: #4b5563;
  border: 1px solid #1f2937;
  border-radius: 999px;
  padding: 7px 10px;
  color: #f9fafb;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
}

/* Accessibility modal toggles */
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 6px 0;
  font-size: 14px;
}
.toggle-row input[type="checkbox"] {
  width: 40px;
  height: 20px;
}

/* Onboarding list */
.onboarding-list {
  margin: 4px 0 0;
  padding-left: 18px;
  font-size: 14px;
  color: #e5e7eb;
}
.onboarding-list li {
  margin-bottom: 4px;
}
</style>
</head>

<body>

<!-- still using your existing puzzles.js -->
<script src="puzzles.js?v=2"></script>

<div id="top-bar">
  <h1 id="title">LOSWords</h1>
</div>

<div id="today"></div>

<div id="nav">
  <button id="prevBtn">&larr; Prev</button>
  <div id="nav-center">
    <button id="accessibilityButton" aria-label="Accessibility options">â™¿</button>
    <button id="onboardingButton" aria-label="How to play LOSWords">?</button>
    <button id="statsButton" aria-label="View stats">ðŸ“Š</button>
    <button id="galleryButton">Gallery</button>
  </div>
  <button id="nextBtn">Next &rarr;</button>
</div>

<div id="clue"></div>

<img id="meme-image" style="display:none" alt="" />
<video id="meme-video" playsinline muted loop style="display:none"></video>

<div id="grid"></div>
<div id="lives"></div>
<div id="keyboard"></div>
<div id="message"></div>

<input id="hiddenInput" type="text"
       autocomplete="off" autocorrect="off"
       autocapitalize="none" spellcheck="false" />

<!-- Stats / end-of-game modal -->
<div id="statsModal" class="modal hidden" aria-modal="true" role="dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="statsTitle">Stats</h2>
      <button id="closeStats" class="modal-close" aria-label="Close stats">&times;</button>
    </div>
    <p id="endText"></p>
    <div class="stats-grid">
      <div class="stat">
        <div class="stat-value" id="stat-played">0</div>
        <div class="stat-label">Played</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-win">0</div>
        <div class="stat-label">Win&nbsp;%</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-current">0</div>
        <div class="stat-label">Current<br />streak</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-max">0</div>
        <div class="stat-label">Max<br />streak</div>
      </div>
    </div>

    <div id="achievementsSection">
      <h3 id="achievementsTitle">Achievements</h3>
      <div id="achievementsList"></div>
    </div>

    <div class="modal-actions">
      <button id="shareButton">Share</button>
      <button id="tipButton">Tip / Buy me a coffee</button>
      <button id="subscribeButton">Subscribe</button>
    </div>
  </div>
</div>

<!-- Accessibility modal -->
<div id="accessibilityModal" class="modal hidden" aria-modal="true" role="dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Accessibility</h2>
      <button id="closeAccessibility" class="modal-close" aria-label="Close accessibility settings">&times;</button>
    </div>
    <p class="modal-subtitle">Tune LOSWords to suit your needs.</p>
    <div class="toggle-row">
      <span>Dyslexia-friendly font</span>
      <input type="checkbox" id="toggleDyslexia" />
    </div>
    <div class="toggle-row">
      <span>High contrast mode</span>
      <input type="checkbox" id="toggleContrast" />
    </div>
    <div class="toggle-row">
      <span>Reduce motion (no confetti)</span>
      <input type="checkbox" id="toggleMotion" />
    </div>
    <div class="toggle-row">
      <span>Sound effects</span>
      <input type="checkbox" id="toggleSound" />
    </div>
  </div>
</div>

<!-- Gentle onboarding modal -->
<div id="onboardingModal" class="modal hidden" aria-modal="true" role="dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Welcome to LOSWords</h2>
      <button id="closeOnboarding" class="modal-close" aria-label="Close welcome">&times;</button>
    </div>
    <p class="modal-subtitle">A quick how-to:</p>
    <ul class="onboarding-list">
      <li>Guess the hidden phrase one letter at a time.</li>
      <li>You have 8 wrong guesses before the puzzle ends.</li>
      <li>Use Prev/Next and the Gallery to explore archive puzzles.</li>
    </ul>
  </div>
</div>

<script>
/************* PUZZLES *************/
const puzzles = window.puzzles || [];

/************* CONSTANTS *************/
const MAX_WRONG = 8;                      // 8 wrong guesses
const STORAGE_KEY = "loswords-stats-v1";
const PREFS_KEY = "loswords-prefs-v1";

/************* PREFERENCES & AUDIO *************/
let preferences = null;
let audioCtx = null;
let masterGain = null;

/************* STATE & DOM *************/
let currentIndex = 0;
let todayIndex = 0;
let gameOver = false;
let currentPuzzleKey = "";
let currentPuzzleNumber = null;

const titleEl     = document.getElementById("title");
const clueEl      = document.getElementById("clue");
const imgEl       = document.getElementById("meme-image");
const videoEl     = document.getElementById("meme-video");
const gridEl      = document.getElementById("grid");
const livesEl     = document.getElementById("lives");
const keyboardEl  = document.getElementById("keyboard");
const messageEl   = document.getElementById("message");
const hiddenInput = document.getElementById("hiddenInput");
const todayEl     = document.getElementById("today");

const statsButton = document.getElementById("statsButton");
const statsModal  = document.getElementById("statsModal");
const closeStats  = document.getElementById("closeStats");
const statsTitle  = document.getElementById("statsTitle");
const endTextEl   = document.getElementById("endText");

const achievementsTitle = document.getElementById("achievementsTitle");
const achievementsList  = document.getElementById("achievementsList");

const prevBtn     = document.getElementById("prevBtn");
const nextBtn     = document.getElementById("nextBtn");

const shareButton     = document.getElementById("shareButton");
const tipButton       = document.getElementById("tipButton");
const subscribeButton = document.getElementById("subscribeButton");

const accessibilityButton = document.getElementById("accessibilityButton");
const accessibilityModal  = document.getElementById("accessibilityModal");
const closeAccessibility  = document.getElementById("closeAccessibility");

const onboardingButton = document.getElementById("onboardingButton");
const onboardingModal  = document.getElementById("onboardingModal");
const closeOnboarding  = document.getElementById("closeOnboarding");

const galleryButton = document.getElementById("galleryButton");

const toggleDyslexia = document.getElementById("toggleDyslexia");
const toggleContrast = document.getElementById("toggleContrast");
const toggleMotion   = document.getElementById("toggleMotion");
const toggleSound    = document.getElementById("toggleSound");

/************* PREFERENCES HELPERS *************/
function loadPrefs() {
  const defaults = {
    dyslexiaFont: false,
    highContrast: false,
    reduceMotion: false,
    soundOn: true
  };
  try {
    const raw = localStorage.getItem(PREFS_KEY);
    if (!raw) return { ...defaults };
    const parsed = JSON.parse(raw);
    return { ...defaults, ...parsed };
  } catch {
    return { ...defaults };
  }
}

function savePrefs() {
  try {
    localStorage.setItem(PREFS_KEY, JSON.stringify(preferences));
  } catch {
    // ignore
  }
}

function applyPrefsToDOM() {
  if (!preferences) return;

  document.body.classList.toggle("dyslexia-font", preferences.dyslexiaFont);
  document.body.classList.toggle("high-contrast", preferences.highContrast);
  document.body.classList.toggle("reduce-motion", preferences.reduceMotion);

  if (toggleDyslexia) toggleDyslexia.checked = preferences.dyslexiaFont;
  if (toggleContrast) toggleContrast.checked = preferences.highContrast;
  if (toggleMotion)   toggleMotion.checked   = preferences.reduceMotion;
  if (toggleSound)    toggleSound.checked    = preferences.soundOn;
}

function initPreferences() {
  preferences = loadPrefs();
  applyPrefsToDOM();
}

/************* AUDIO (WEB AUDIO SOFT TONES) *************/
function initAudio() {
  if (audioCtx) return;
  try {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    audioCtx = new AC();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.15;
    masterGain.connect(audioCtx.destination);
  } catch {
    audioCtx = null;
  }
}

function ensureAudioRunning() {
  if (!audioCtx) return;
  if (audioCtx.state === "suspended") {
    audioCtx.resume().catch(() => {});
  }
}

function playBeep(freq, duration = 0.12, volume = 1) {
  if (!preferences || !preferences.soundOn) return;
  initAudio();
  if (!audioCtx || !masterGain) return;
  ensureAudioRunning();

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const now = audioCtx.currentTime;

  osc.type = "sine";
  osc.frequency.setValueAtTime(freq, now);

  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(volume, now + 0.01);
  gain.gain.linearRampToValueAtTime(0, now + duration);

  osc.connect(gain);
  gain.connect(masterGain);

  osc.start(now);
  osc.stop(now + duration + 0.05);
}

function playCorrectSound() {
  playBeep(880, 0.12, 0.9);
}
function playWrongSound() {
  playBeep(220, 0.15, 0.8);
}
function playWinSound() {
  playBeep(1046, 0.16, 0.9);
  setTimeout(() => playBeep(1318, 0.16, 0.9), 160);
}
function playLossSound() {
  playBeep(196, 0.3, 0.8);
}

/************* DATE LABEL (per puzzle index) *************/
function getDateForIndex(index) {
  const today = new Date();
  const diff = index - todayIndex; // how many days away from today
  const d = new Date(today);
  d.setDate(d.getDate() + diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

function updateDateLabel() {
  if (!puzzles.length) {
    todayEl.textContent = "";
    return;
  }
  const d = getDateForIndex(currentIndex);
  const label = d.toLocaleDateString(undefined, {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric"
  });

  if (currentIndex === todayIndex) {
    todayEl.textContent = `${label} â€“ Today's puzzle`;
  } else {
    todayEl.textContent = `${label} â€“ Archive puzzle`;
  }
}

/************* MEDIA *************/
function showMedia(file) {
  if (!file) {
    imgEl.style.display = "none";
    videoEl.style.display = "none";
    return;
  }
  const lower = file.toLowerCase();
  if (lower.endsWith(".mp4")) {
    imgEl.style.display = "none";
    videoEl.style.display = "block";
    videoEl.src = file;
    videoEl.play().catch(()=>{});
  } else {
    videoEl.style.display = "none";
    videoEl.pause();
    imgEl.style.display = "block";
    imgEl.src = file;
  }
}

/************* KEYBOARD *************/
const keyButtons = {};
const keyboardLayout = [
  ["Q","W","E","R","T","Y","U","I","O","P"],
  ["A","S","D","F","G","H","J","K","L"],
  ["Z","X","C","V","B","N","M"]
];

function buildKeyboard() {
  keyboardEl.innerHTML = "";
  keyboardLayout.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.className = "key-row";

    row.forEach(key => {
      const btn = document.createElement("button");
      btn.classList.add("key");
      btn.textContent = key;
      btn.dataset.key = key;

      btn.addEventListener("click", () => {
        handleKeyPress(key);
        hiddenInput.focus();
      });

      keyButtons[key] = btn;
      rowDiv.appendChild(btn);
    });

    keyboardEl.appendChild(rowDiv);
  });
}

function resetKeyboard() {
  for (let k in keyButtons) {
    keyButtons[k].classList.remove("correct","present","absent");
  }
}

function setKeyStatus(letter, status) {
  const key = letter.toUpperCase();
  const btn = keyButtons[key];
  if (!btn) return;

  if (status === "correct") {
    btn.classList.remove("present","absent");
    btn.classList.add("correct");
  } else if (status === "present") {
    if (!btn.classList.contains("correct")) {
      btn.classList.remove("absent");
      btn.classList.add("present");
    }
  } else if (status === "absent") {
    if (!btn.classList.contains("correct") &&
        !btn.classList.contains("present")) {
      btn.classList.add("absent");
    }
  }
}

/************* PHRASE MODE ONLY *************/
let pAnswer = "";
let pTiles = [];
let pRevealed = {};
let pGuessed = new Set();
let pUnique = 0;
let pWrong = 0;

function setupPhrase(p) {
  pAnswer = p.answer.toLowerCase();
  pTiles = [];
  pRevealed = {};
  pGuessed.clear();
  pWrong = 0;

  const letters = new Set();
  for (let ch of pAnswer) {
    if (/[a-z]/.test(ch)) letters.add(ch);
  }
  pUnique = letters.size;

  const wrapper = document.createElement("div");
  wrapper.className = "phrase-container";

  let group = null;

  for (let i = 0; i < pAnswer.length; i++) {
    const ch = pAnswer[i];

    if (ch === " ") {
      group = null;      // new word â€“ bigger gap between words
      pTiles[i] = null;
      continue;
    }

    if (!group) {
      group = document.createElement("div");
      group.className = "phrase-word";
      wrapper.appendChild(group);
    }

    const tile = document.createElement("div");
    tile.className = "phrase-tile";

    if (/[a-z]/.test(ch)) {
      tile.textContent = "";
    } else {
      tile.classList.add("fixed");
      tile.textContent = ch;
    }

    group.appendChild(tile);
    pTiles[i] = tile;

    if (ch === "-") {
      group = null;      // allow wrapping after hyphens
    }
  }

  gridEl.appendChild(wrapper);
  updateLives();
}

function handlePhraseKey(letter) {
  if (gameOver) return;

  const l = letter.toLowerCase();
  if (!/[a-z]/.test(l)) return;

  // If already guessed this letter
  if (pGuessed.has(l)) {
    // If it was a wrong letter, show alert + message
    if (!pAnswer.includes(l)) {
      const msg = `${letter.toUpperCase()} is not in the phrase and has already been guessed.`;
      alert(msg);
      showMessage(msg);
    }
    return;
  }

  pGuessed.add(l);

  if (pAnswer.includes(l)) {
    playCorrectSound();

    pAnswer.split("").forEach((ch, i) => {
      if (ch === l && pTiles[i]) {
        pTiles[i].classList.add("revealed");
        pTiles[i].textContent = letter.toUpperCase();
      }
    });

    setKeyStatus(letter, "correct");
    pRevealed[l] = true;

    if (Object.keys(pRevealed).length === pUnique) {
      showMessage("Solved! ðŸŽ‰");
      gameOver = true;
      const isToday = currentIndex === todayIndex;
      playWinSound();
      recordResult(true, isToday, currentPuzzleKey, pWrong);
      launchConfetti();
      openEndModal(true, isToday);
    }
  } else {
    playWrongSound();
    pWrong++;
    setKeyStatus(letter, "absent");
    updateLives();
    if (pWrong >= MAX_WRONG) {
      showMessage("Out of guesses! " + pAnswer.toUpperCase());
      gameOver = true;
      revealFullAnswer();
      const isToday = currentIndex === todayIndex;
      playLossSound();
      recordResult(false, isToday, currentPuzzleKey, pWrong);
      openEndModal(false, isToday);
    }
  }
}

function updateLives() {
  livesEl.textContent = `Wrong guesses: ${pWrong} / ${MAX_WRONG}`;
}

function revealFullAnswer() {
  pAnswer.split("").forEach((ch, i) => {
    if (/[a-z]/.test(ch) && pTiles[i]) {
      pTiles[i].classList.add("revealed");
      pTiles[i].textContent = ch.toUpperCase();
    }
  });
}

/************* SIMPLE CONFETTI *************/
function launchConfetti() {
  if (preferences && preferences.reduceMotion) return;

  const duration = 1500;
  const animationEnd = Date.now() + duration;
  const colors = ["#fde68a","#fca5a5","#bfdbfe","#bbf7d0","#e9d5ff"];

  const container = document.createElement("div");
  container.style.position = "fixed";
  container.style.inset = "0";
  container.style.pointerEvents = "none";
  container.style.overflow = "hidden";
  document.body.appendChild(container);

  const particles = [];
  const count = 120;

  for (let i = 0; i < count; i++) {
    const el = document.createElement("div");
    el.style.position = "absolute";
    el.style.width = "8px";
    el.style.height = "14px";
    el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    el.style.top = "-20px";
    el.style.left = Math.random() * 100 + "%";
    el.style.opacity = "1";
    el.style.transform = `rotate(${Math.random() * 360}deg)`;
    container.appendChild(el);

    particles.push({
      elem: el,
      x: Math.random() * window.innerWidth,
      y: -20,
      angle: Math.random() * Math.PI * 2,
      speed: 2 + Math.random() * 3
    });
  }

  function frame() {
    const now = Date.now();
    const timeLeft = animationEnd - now;
    if (timeLeft <= 0) {
      document.body.removeChild(container);
      return;
    }
    const progress = 1 - timeLeft / duration;

    particles.forEach(p => {
      p.y += p.speed;
      p.x += Math.sin(p.angle) * 1.5;
      p.angle += 0.01;

      p.elem.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${progress * 720}deg)`;
      p.elem.style.opacity = String(1 - progress);
    });

    requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);
}

/************* INPUT *************/
function handleKeyPress(k) {
  if (gameOver) return;
  const key = k.toUpperCase();
  if (/^[A-Z]$/.test(key)) {
    handlePhraseKey(key);
  }
}

document.addEventListener("keydown", e => {
  if (/^[a-zA-Z]$/.test(e.key)) {
    handleKeyPress(e.key);
  }
});

document.body.addEventListener("click", () => hiddenInput.focus());

/************* DAILY PUZZLE LOGIC *************/
function getTodayKey() {
  const d = new Date();
  const year  = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day   = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

function getDailyIndex() {
  if (!puzzles.length) return 0;
  const epoch = new Date(2025, 0, 1);  // 1 Jan 2025 local
  const today = new Date();

  epoch.setHours(0,0,0,0);
  today.setHours(0,0,0,0);

  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.floor((today - epoch) / msPerDay);

  // Support dates before epoch too
  const idx = ((diffDays % puzzles.length) + puzzles.length) % puzzles.length;
  return idx;
}

/************* STATS *************/
function loadStats() {
  const defaults = {
    gamesPlayed: 0,
    wins: 0,
    currentStreak: 0,
    maxStreak: 0,
    lastPlayedDate: null,
    lastResult: null,
    completed: {},      // per-puzzle completion
    flawlessWins: 0,
    archivePlayed: 0
  };
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { ...defaults };
    const parsed = JSON.parse(raw);
    const merged = { ...defaults, ...parsed };
    if (!merged.completed) merged.completed = {};
    if (merged.flawlessWins == null) merged.flawlessWins = 0;
    if (merged.archivePlayed == null) merged.archivePlayed = 0;
    return merged;
  } catch {
    return { ...defaults };
  }
}

function saveStats(stats) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
  } catch {
    // ignore storage errors
  }
}

/*
  All finished games increment:
   - gamesPlayed
   - wins (if didWin)

  Only today's game (isToday === true) affects:
   - currentStreak
   - maxStreak
   - lastPlayedDate / lastResult

  Each puzzle also recorded in stats.completed[puzzleKey].
  wrongGuesses is used for "flawless" wins.
*/
function recordResult(didWin, isToday, puzzleKey, wrongGuesses) {
  const stats = loadStats();
  const todayKey = getTodayKey();

  if (!stats.completed) stats.completed = {};
  if (stats.flawlessWins == null) stats.flawlessWins = 0;
  if (stats.archivePlayed == null) stats.archivePlayed = 0;

  const alreadyPlayed = !!stats.completed[puzzleKey]?.played;

  // Count towards Played/Wins only once per puzzle
  if (!alreadyPlayed) {
    stats.gamesPlayed += 1;
    if (didWin) {
      stats.wins += 1;
    }
    if (!isToday) {
      stats.archivePlayed += 1;
    }
    if (didWin && wrongGuesses === 0) {
      stats.flawlessWins += 1;
    }
  }

  if (isToday) {
    if (stats.lastPlayedDate !== todayKey) {
      // Only update streak once per day
      if (didWin) {
        if (stats.lastPlayedDate && stats.lastResult === "win") {
          stats.currentStreak += 1;
        } else {
          stats.currentStreak = 1;
        }
        if (stats.currentStreak > stats.maxStreak) {
          stats.maxStreak = stats.currentStreak;
        }
        stats.lastResult = "win";
      } else {
        stats.currentStreak = 0;
        stats.lastResult = "loss";
      }
      stats.lastPlayedDate = todayKey;
    }
  }

  stats.completed[puzzleKey] = { played: true, won: didWin };
  saveStats(stats);
}

function computeAchievements(stats) {
  const achievements = [];

  if (stats.wins >= 1) {
    achievements.push({
      id: "firstWin",
      label: "ðŸ… First win",
      description: "Win your first puzzle."
    });
  }
  if (stats.maxStreak >= 3) {
    achievements.push({
      id: "streak3",
      label: "ðŸ”¥ 3-day streak",
      description: "Win 3 daily puzzles in a row."
    });
  }
  if (stats.maxStreak >= 7) {
    achievements.push({
      id: "streak7",
      label: "ðŸ’Ž 7-day streak",
      description: "Win 7 daily puzzles in a row."
    });
  }
  if ((stats.flawlessWins || 0) >= 1) {
    achievements.push({
      id: "flawless",
      label: "âœ¨ Flawless solve",
      description: "Solve a puzzle with no wrong guesses."
    });
  }
  if ((stats.archivePlayed || 0) >= 3) {
    achievements.push({
      id: "archive",
      label: "ðŸ“š Archive explorer",
      description: "Play at least 3 archive puzzles."
    });
  }
  if (stats.gamesPlayed >= 10) {
    achievements.push({
      id: "tenPlayed",
      label: "ðŸ”Ÿ 10 puzzles played",
      description: "Play 10 puzzles in total."
    });
  }

  return achievements;
}

function updateAchievementsUI(stats) {
  if (!achievementsList || !achievementsTitle) return;

  const achievements = computeAchievements(stats);
  achievementsList.innerHTML = "";

  if (!achievements.length) {
    achievementsTitle.textContent = "Achievements";
    const p = document.createElement("p");
    p.textContent = "Keep playing to unlock badges!";
    p.style.fontSize = "13px";
    p.style.color = "#9ca3af";
    achievementsList.appendChild(p);
    return;
  }

  achievementsTitle.textContent = "Achievements";
  achievements.forEach(a => {
    const badge = document.createElement("div");
    badge.className = "achievement-badge";
    badge.textContent = a.label;
    badge.title = a.description;
    achievementsList.appendChild(badge);
  });
}

function updateStatsUI() {
  const stats = loadStats();
  const winPct = stats.gamesPlayed
    ? Math.round((stats.wins / stats.gamesPlayed) * 100)
    : 0;

  document.getElementById("stat-played").textContent  = stats.gamesPlayed;
  document.getElementById("stat-win").textContent     = winPct;
  document.getElementById("stat-current").textContent = stats.currentStreak;
  document.getElementById("stat-max").textContent     = stats.maxStreak;

  updateAchievementsUI(stats);
}

/************* END-OF-GAME MODAL *************/
function openEndModal(didWin, isToday) {
  updateStatsUI();

  if (didWin) {
    statsTitle.textContent = "ðŸŽ‰ Congratulations!";
    endTextEl.textContent =
      (isToday
        ? "You solved today's LOSWords. See you tomorrow!"
        : "You solved this archive LOSWords. Come back tomorrow for a new one!");
  } else {
    statsTitle.textContent = "ðŸ˜… Good try!";
    endTextEl.textContent =
      (isToday
        ? `The answer was: ${pAnswer.toUpperCase()}. See you tomorrow!`
        : `The answer was: ${pAnswer.toUpperCase()}. This was an archive LOSWords puzzle.`);
  }

  statsModal.classList.remove("hidden");
}

/************* NAV BUTTONS (ARCHIVE) *************/
function updateNavButtons() {
  if (!puzzles.length) {
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    return;
  }

  // Earliest puzzle is index 0
  prevBtn.disabled = currentIndex <= 0;

  // Latest playable archive is today's puzzle
  nextBtn.disabled = currentIndex >= todayIndex;
}

prevBtn.addEventListener("click", () => {
  if (currentIndex > 0) {
    currentIndex -= 1;
    loadPuzzle(currentIndex);
    updateNavButtons();
  }
});

nextBtn.addEventListener("click", () => {
  if (currentIndex < todayIndex) {
    currentIndex += 1;
    loadPuzzle(currentIndex);
    updateNavButtons();
  }
});

/************* SHARE / TIP / SUBSCRIBE *************/
shareButton.addEventListener("click", () => {
  const url = window.location.href;
  const puzzlePart = currentPuzzleNumber != null
    ? `Puzzle #${currentPuzzleNumber}`
    : "LOSWords";
  const text = `I'm playing LOSWords! ${puzzlePart}. Can you solve it?\n\n${url}`;

  if (navigator.share) {
    navigator.share({ title: "LOSWords", text, url }).catch(() => {});
  } else if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => alert("Share text copied to clipboard!"))
      .catch(() => alert("Share this text:\n\n" + text));
  } else {
    alert("Share this text:\n\n" + text);
  }
});

// TODO: replace YOURNAME with your Buy Me a Coffee handle
tipButton.addEventListener("click", () => {
  window.open("https://www.buymeacoffee.com/YOURNAME", "_blank");
});

// TODO: replace YOUREMAIL@example.com with your email / mailing list endpoint
subscribeButton.addEventListener("click", () => {
  window.location.href =
    "mailto:YOUREMAIL@example.com?subject=Subscribe%20to%20LOSWords&body=Hi%2C%20please%20subscribe%20me%20to%20LOSWords%20updates.";
});

/************* LOADING PUZZLE *************/
function loadPuzzle(index) {
  if (!puzzles.length) {
    titleEl.textContent = "LOSWords";
    clueEl.textContent  = "No puzzles loaded. Check puzzles.js.";
    gridEl.innerHTML    = "";
    showMedia(null);
    todayEl.textContent = "";
    return;
  }

  const p = puzzles[index % puzzles.length];
  const number = p.id != null ? p.id : (index + 1);
  currentPuzzleKey = (p.id != null) ? String(p.id) : `index-${index}`;
  currentPuzzleNumber = number;

  gameOver = false;

  resetKeyboard();
  gridEl.innerHTML = "";
  messageEl.textContent = "";
  livesEl.textContent = "";
  endTextEl.textContent = "";
  statsTitle.textContent = "Stats";

  titleEl.textContent = "LOSWords #" + number;
  showMedia(p.image);

  clueEl.innerHTML =
    p.clue +
    `<br><span class="instruction">Guess the phrase one letter at a time. You have ${MAX_WRONG} wrong guesses.</span>`;

  setupPhrase(p);
  updateLives();
  updateDateLabel();

  // Check if this puzzle has already been played
  const stats = loadStats();
  const completed = stats.completed || {};
  const entry = completed[currentPuzzleKey];

  if (entry && entry.played) {
    // Always show the full answer if they've played it
    revealFullAnswer();
    gameOver = true;
    if (entry.won) {
      showMessage("You've already solved this LOSWords.");
    } else {
      showMessage("You've already played this LOSWords. The answer is shown above.");
    }
  } else {
    // Extra lock: if this is today's puzzle AND stats say today's already played,
    // but for some reason it's not in completed (older data), still lock it.
    const todayKey = getTodayKey();
    if (index === todayIndex &&
        stats.lastPlayedDate === todayKey) {
      revealFullAnswer();
      gameOver = true;
      showMessage("You've already played today's LOSWORDS. Come back tomorrow!");
    }
  }

  setTimeout(() => hiddenInput.focus(), 50);
}

/************* STATS MODAL EVENTS *************/
statsButton.addEventListener("click", () => {
  // Plain stats view
  statsTitle.textContent = "Stats";
  endTextEl.textContent = "";
  updateStatsUI();
  statsModal.classList.remove("hidden");
});

closeStats.addEventListener("click", () => {
  statsModal.classList.add("hidden");
});

statsModal.addEventListener("click", (e) => {
  if (e.target === statsModal) {
    statsModal.classList.add("hidden");
  }
});

/************* ACCESSIBILITY MODAL EVENTS *************/
accessibilityButton.addEventListener("click", () => {
  applyPrefsToDOM();
  accessibilityModal.classList.remove("hidden");
});

closeAccessibility.addEventListener("click", () => {
  accessibilityModal.classList.add("hidden");
});

accessibilityModal.addEventListener("click", (e) => {
  if (e.target === accessibilityModal) {
    accessibilityModal.classList.add("hidden");
  }
});

toggleDyslexia.addEventListener("change", () => {
  preferences.dyslexiaFont = toggleDyslexia.checked;
  applyPrefsToDOM();
  savePrefs();
});

toggleContrast.addEventListener("change", () => {
  preferences.highContrast = toggleContrast.checked;
  applyPrefsToDOM();
  savePrefs();
});

toggleMotion.addEventListener("change", () => {
  preferences.reduceMotion = toggleMotion.checked;
  applyPrefsToDOM();
  savePrefs();
});

toggleSound.addEventListener("change", () => {
  preferences.soundOn = toggleSound.checked;
  savePrefs();
});

/************* ONBOARDING MODAL EVENTS *************/
onboardingButton.addEventListener("click", () => {
  onboardingModal.classList.remove("hidden");
});

closeOnboarding.addEventListener("click", () => {
  onboardingModal.classList.add("hidden");
});

onboardingModal.addEventListener("click", (e) => {
  if (e.target === onboardingModal) {
    onboardingModal.classList.add("hidden");
  }
});

/************* GALLERY BUTTON *************/
galleryButton.addEventListener("click", () => {
  // gallery.html should link back as LOSWords2.html?puzzleId=ID
  window.location.href = "gallery.html";
});

/************* START *************/
initPreferences();
buildKeyboard();
todayIndex = getDailyIndex();

// Support deep link from gallery: LOSWords2.html?puzzleId=XXX (where XXX matches puzzle.id)
let initialIndex = todayIndex;
if (puzzles.length) {
  const params = new URLSearchParams(window.location.search);
  const puzzleIdParam = params.get("puzzleId");
  if (puzzleIdParam != null) {
    const idx = puzzles.findIndex(p => String(p.id) === String(puzzleIdParam));
    if (idx !== -1) {
      initialIndex = idx;
    }
  }
}

currentIndex = initialIndex;
loadPuzzle(currentIndex);
updateNavButtons();

function showMessage(msg) {
  messageEl.textContent = msg;
}
</script>

</body>
</html>
